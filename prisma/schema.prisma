// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  hashedPassword    String?
  isActive          Boolean        @default(true)
  isEmailVerified   Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  profile           UserProfile?
  addresses         UserAddress[]
  carts             Cart[]
  orders            Order[]
  authProviders     AuthProvider[]
  sessions          Session[]
  roles             UserRole[]
  wishlists         Wishlist[]
}

model AuthProvider {
  id              String   @id @default(cuid())
  userId          String
  provider        String
  providerUserId  String
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerUserId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  fullName  String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserAddress {
  id            String   @id @default(cuid())
  userId        String
  label         String?
  recipientName String?
  phone         String?
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  pincode       String
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Product {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  description String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  variants    ProductVariant[]
  images      ProductImage[]
  wishlists   Wishlist[]
}

model Flavour {
  id        String           @id @default(cuid())
  name      String           @unique
  slug      String           @unique
  isActive  Boolean          @default(true)
  
  variants  ProductVariant[]
}

model PacketSize {
  id          String           @id @default(cuid())
  weightGrams Int              @unique
  label       String
  isActive    Boolean          @default(true)
  
  variants    ProductVariant[]
}

model ProductVariant {
  id            String          @id @default(cuid())
  productId     String
  flavourId     String
  packetSizeId  String
  sku           String          @unique
  price         Decimal         @db.Decimal(10, 2)
  mrp           Decimal?        @db.Decimal(10, 2)
  stockQuantity Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  flavour       Flavour         @relation(fields: [flavourId], references: [id])
  packetSize    PacketSize      @relation(fields: [packetSizeId], references: [id])
  
  cartItems     CartItem[]
  orderItems    OrderItem[]
  inventoryLogs InventoryLog[]
  
  @@unique([productId, flavourId, packetSizeId])
  @@index([productId])
}

model ProductImage {
  id         String   @id @default(cuid())
  productId  String
  url        String
  altText    String?
  sortOrder  Int      @default(0)
  
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Cart {
  id         String     @id @default(cuid())
  userId     String?
  sessionId  String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  user       User?      @relation(fields: [userId], references: [id])
  items      CartItem[]
}

model CartItem {
  id               String         @id @default(cuid())
  cartId           String
  productVariantId String
  quantity         Int            @default(1)
  createdAt        DateTime       @default(now())
  
  cart             Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  
  @@unique([cartId, productVariantId])
}

model Order {
  id                  String              @id @default(cuid())
  orderNumber         String              @unique
  userId              String?
  email               String
  phone               String
  orderStatus         String              @default("pending")
  paymentStatus       String              @default("pending")
  subtotalAmount      Decimal             @db.Decimal(10, 2)
  deliveryCharge      Decimal             @default(0) @db.Decimal(10, 2)
  discountAmount      Decimal             @default(0) @db.Decimal(10, 2)
  totalAmount         Decimal             @db.Decimal(10, 2)
  shippingName        String
  shippingPhone       String
  shippingAddress1    String
  shippingAddress2    String?
  shippingCity        String
  shippingState       String
  shippingPincode     String
  shippingCountry     String              @default("India")
  createdAt           DateTime            @default(now())
  
  user                User?               @relation(fields: [userId], references: [id])
  items               OrderItem[]
  statusHistory       OrderStatusHistory[]
  shipments           Shipment[]
  payments            Payment[]
  
  @@index([userId])
}

model OrderItem {
  id                   String         @id @default(cuid())
  orderId              String
  productVariantId     String
  productNameSnapshot  String
  flavourSnapshot      String?
  packetSizeSnapshot   String?
  skuSnapshot          String?
  unitPriceSnapshot    Decimal        @db.Decimal(10, 2)
  quantity             Int
  lineTotal            Decimal        @db.Decimal(10, 2)
  
  order                Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productVariant       ProductVariant @relation(fields: [productVariantId], references: [id])
}

model OrderStatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  status    String
  note      String?
  changedBy String?
  createdAt DateTime @default(now())
  
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Shipment {
  id               String    @id @default(cuid())
  orderId          String
  shipmentNumber   String?   @unique
  courierName      String?
  trackingNumber   String?
  shippedAt        DateTime?
  expectedDelivery DateTime?
  deliveredAt      DateTime?
  status           String    @default("pending")
  
  order            Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([trackingNumber])
}

model Payment {
  id             String   @id @default(cuid())
  orderId        String
  paymentGateway String
  paymentId      String
  paymentMethod  String?
  amount         Decimal  @db.Decimal(10, 2)
  status         String
  meta           Json?
  createdAt      DateTime @default(now())
  
  order          Order    @relation(fields: [orderId], references: [id])
  refunds        Refund[]
}

model Refund {
  id        String   @id @default(cuid())
  paymentId String
  refundId  String?
  amount    Decimal  @db.Decimal(10, 2)
  reason    String?
  status    String
  createdAt DateTime @default(now())
  
  payment   Payment  @relation(fields: [paymentId], references: [id])
}

model DeliveryRule {
  id            String  @id @default(cuid())
  minOrderValue Decimal @default(0) @db.Decimal(10, 2)
  maxOrderValue Decimal @default(99999999) @db.Decimal(10, 2)
  deliveryCharge Decimal @default(0) @db.Decimal(10, 2)
}

model Coupon {
  id             String    @id @default(cuid())
  code           String    @unique
  discountType   String
  discountValue  Decimal   @db.Decimal(10, 2)
  minOrderValue  Decimal?  @db.Decimal(10, 2)
  maxUses        Int       @default(0)
  expiresAt      DateTime?
}

model InventoryLog {
  id               String         @id @default(cuid())
  productVariantId String
  changeQty        Int
  reason           String?
  referenceType    String?
  referenceId      String?
  createdAt        DateTime       @default(now())
  
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
}

model Role {
  id    String     @id @default(cuid())
  name  String     @unique
  
  users UserRole[]
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
}

model AuditLog {
  id           String   @id @default(cuid())
  actorUserId  String?
  action       String
  resourceType String
  resourceId   String?
  payload      Json?
  createdAt    DateTime @default(now())
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])
  
  @@unique([userId, productId])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}
